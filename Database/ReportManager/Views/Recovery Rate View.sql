/*
 * Copy the following Code in the sql Multiline textbox.
SELECT  sdv.code, drr.effective_date, drr.recovery, drr.months,	drr.rate
FROM default_recovery_rate drr
INNER JOIN static_data_value sdv ON sdv.value_id = drr.debt_rating
*/
BEGIN TRY    BEGIN TRAN   
   DECLARE @report_id_data_source_dest INT       SELECT @report_id_data_source_dest = report_id   FROM report r   WHERE r.[name] = NULL
   IF EXISTS (SELECT 1               FROM data_source               WHERE [name] = 'Recovery Rate View'      AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1))        BEGIN    UPDATE data_source    SET alias = 'RRV', description = ''    , [tsql] = CAST('' AS VARCHAR(MAX)) + 'SELECT  sdv.code, drr.effective_date, drr.recovery, drr.months,' + CHAR(9) + 'drr.rate' + CHAR(13) + '' + CHAR(10) + 'FROM default_recovery_rate drr' + CHAR(13) + '' + CHAR(10) + 'INNER JOIN static_data_value sdv ON sdv.value_id = drr.debt_rating', report_id = @report_id_data_source_dest     WHERE [name] = 'Recovery Rate View'     AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1)   END    ELSE   BEGIN    INSERT INTO data_source([type_id], [name], [alias], [description], [tsql], report_id)    SELECT TOP 1 1 AS [type_id], 'Recovery Rate View' AS [name], 'RRV' AS ALIAS, '' AS [description],'SELECT  sdv.code, drr.effective_date, drr.recovery, drr.months,' + CHAR(9) + 'drr.rate' + CHAR(13) + '' + CHAR(10) + 'FROM default_recovery_rate drr' + CHAR(13) + '' + CHAR(10) + 'INNER JOIN static_data_value sdv ON sdv.value_id = drr.debt_rating' AS [tsql], @report_id_data_source_dest AS report_id   END    
   IF OBJECT_ID('tempdb..#data_source_column', 'U') IS NOT NULL    DROP TABLE #data_source_column    CREATE TABLE #data_source_column(column_id INT) 
   IF EXISTS (SELECT 1               FROM data_source_column dsc               INNER JOIN data_source ds on ds.data_source_id = dsc.source_id               WHERE ds.[name] = 'Recovery Rate View'               AND dsc.name =  'code'      AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1))   BEGIN    UPDATE dsc      SET alias = 'Debt Rating/Counterparty'        , reqd_param = 0, widget_id = 1, datatype_id = 5, param_data_source = NULL, param_default_value = NULL, append_filter = 1, tooltip = NULL, column_template = 0    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    FROM data_source_column dsc    INNER JOIN data_source ds ON ds.data_source_id = dsc.source_id     WHERE ds.[name] = 'Recovery Rate View'     AND dsc.name =  'code'     AND ISNULL(report_id, -1) = ISNULL(@report_id_data_source_dest, -1)   END    ELSE   BEGIN    INSERT INTO data_source_column(source_id, [name], ALIAS, reqd_param, widget_id    , datatype_id, param_data_source, param_default_value, append_filter, tooltip, column_template)    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    SELECT TOP 1 ds.data_source_id AS source_id, 'code' AS [name], 'Debt Rating/Counterparty' AS ALIAS, 0 AS reqd_param, 1 AS widget_id, 5 AS datatype_id, NULL AS param_data_source, NULL AS param_default_value, 1 AS append_filter, NULL  AS tooltip,0 AS column_template  FROM sys.objects o    INNER JOIN data_source ds ON ds.[name] = 'Recovery Rate View'     AND ISNULL(ds.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    LEFT JOIN report r ON r.report_id = ds.report_id     AND ds.[type_id] = 2     AND ISNULL(r.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    WHERE ds.type_id = (CASE WHEN r.report_id IS NULL THEN ds.type_id ELSE 2 END)   END       
   IF EXISTS (SELECT 1               FROM data_source_column dsc               INNER JOIN data_source ds on ds.data_source_id = dsc.source_id               WHERE ds.[name] = 'Recovery Rate View'               AND dsc.name =  'effective_date'      AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1))   BEGIN    UPDATE dsc      SET alias = 'Effective Date'        , reqd_param = 0, widget_id = 6, datatype_id = 2, param_data_source = NULL, param_default_value = NULL, append_filter = 1, tooltip = NULL, column_template = 4    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    FROM data_source_column dsc    INNER JOIN data_source ds ON ds.data_source_id = dsc.source_id     WHERE ds.[name] = 'Recovery Rate View'     AND dsc.name =  'effective_date'     AND ISNULL(report_id, -1) = ISNULL(@report_id_data_source_dest, -1)   END    ELSE   BEGIN    INSERT INTO data_source_column(source_id, [name], ALIAS, reqd_param, widget_id    , datatype_id, param_data_source, param_default_value, append_filter, tooltip, column_template)    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    SELECT TOP 1 ds.data_source_id AS source_id, 'effective_date' AS [name], 'Effective Date' AS ALIAS, 0 AS reqd_param, 6 AS widget_id, 2 AS datatype_id, NULL AS param_data_source, NULL AS param_default_value, 1 AS append_filter, NULL  AS tooltip,4 AS column_template  FROM sys.objects o    INNER JOIN data_source ds ON ds.[name] = 'Recovery Rate View'     AND ISNULL(ds.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    LEFT JOIN report r ON r.report_id = ds.report_id     AND ds.[type_id] = 2     AND ISNULL(r.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    WHERE ds.type_id = (CASE WHEN r.report_id IS NULL THEN ds.type_id ELSE 2 END)   END       
   IF EXISTS (SELECT 1               FROM data_source_column dsc               INNER JOIN data_source ds on ds.data_source_id = dsc.source_id               WHERE ds.[name] = 'Recovery Rate View'               AND dsc.name =  'months'      AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1))   BEGIN    UPDATE dsc      SET alias = 'Months'        , reqd_param = 0, widget_id = 1, datatype_id = 4, param_data_source = NULL, param_default_value = NULL, append_filter = 1, tooltip = NULL, column_template = 2    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    FROM data_source_column dsc    INNER JOIN data_source ds ON ds.data_source_id = dsc.source_id     WHERE ds.[name] = 'Recovery Rate View'     AND dsc.name =  'months'     AND ISNULL(report_id, -1) = ISNULL(@report_id_data_source_dest, -1)   END    ELSE   BEGIN    INSERT INTO data_source_column(source_id, [name], ALIAS, reqd_param, widget_id    , datatype_id, param_data_source, param_default_value, append_filter, tooltip, column_template)    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    SELECT TOP 1 ds.data_source_id AS source_id, 'months' AS [name], 'Months' AS ALIAS, 0 AS reqd_param, 1 AS widget_id, 4 AS datatype_id, NULL AS param_data_source, NULL AS param_default_value, 1 AS append_filter, NULL  AS tooltip,2 AS column_template  FROM sys.objects o    INNER JOIN data_source ds ON ds.[name] = 'Recovery Rate View'     AND ISNULL(ds.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    LEFT JOIN report r ON r.report_id = ds.report_id     AND ds.[type_id] = 2     AND ISNULL(r.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    WHERE ds.type_id = (CASE WHEN r.report_id IS NULL THEN ds.type_id ELSE 2 END)   END       
   IF EXISTS (SELECT 1               FROM data_source_column dsc               INNER JOIN data_source ds on ds.data_source_id = dsc.source_id               WHERE ds.[name] = 'Recovery Rate View'               AND dsc.name =  'rate'      AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1))   BEGIN    UPDATE dsc      SET alias = 'Rate'        , reqd_param = 0, widget_id = 1, datatype_id = 3, param_data_source = NULL, param_default_value = NULL, append_filter = 1, tooltip = NULL, column_template = 2    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    FROM data_source_column dsc    INNER JOIN data_source ds ON ds.data_source_id = dsc.source_id     WHERE ds.[name] = 'Recovery Rate View'     AND dsc.name =  'rate'     AND ISNULL(report_id, -1) = ISNULL(@report_id_data_source_dest, -1)   END    ELSE   BEGIN    INSERT INTO data_source_column(source_id, [name], ALIAS, reqd_param, widget_id    , datatype_id, param_data_source, param_default_value, append_filter, tooltip, column_template)    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    SELECT TOP 1 ds.data_source_id AS source_id, 'rate' AS [name], 'Rate' AS ALIAS, 0 AS reqd_param, 1 AS widget_id, 3 AS datatype_id, NULL AS param_data_source, NULL AS param_default_value, 1 AS append_filter, NULL  AS tooltip,2 AS column_template  FROM sys.objects o    INNER JOIN data_source ds ON ds.[name] = 'Recovery Rate View'     AND ISNULL(ds.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    LEFT JOIN report r ON r.report_id = ds.report_id     AND ds.[type_id] = 2     AND ISNULL(r.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    WHERE ds.type_id = (CASE WHEN r.report_id IS NULL THEN ds.type_id ELSE 2 END)   END       
   IF EXISTS (SELECT 1               FROM data_source_column dsc               INNER JOIN data_source ds on ds.data_source_id = dsc.source_id               WHERE ds.[name] = 'Recovery Rate View'               AND dsc.name =  'recovery'      AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1))   BEGIN    UPDATE dsc      SET alias = 'Recovery'        , reqd_param = 0, widget_id = 1, datatype_id = 1, param_data_source = NULL, param_default_value = NULL, append_filter = 1, tooltip = NULL, column_template = 0    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    FROM data_source_column dsc    INNER JOIN data_source ds ON ds.data_source_id = dsc.source_id     WHERE ds.[name] = 'Recovery Rate View'     AND dsc.name =  'recovery'     AND ISNULL(report_id, -1) = ISNULL(@report_id_data_source_dest, -1)   END    ELSE   BEGIN    INSERT INTO data_source_column(source_id, [name], ALIAS, reqd_param, widget_id    , datatype_id, param_data_source, param_default_value, append_filter, tooltip, column_template)    OUTPUT INSERTED.data_source_column_id INTO #data_source_column(column_id)    SELECT TOP 1 ds.data_source_id AS source_id, 'recovery' AS [name], 'Recovery' AS ALIAS, 0 AS reqd_param, 1 AS widget_id, 1 AS datatype_id, NULL AS param_data_source, NULL AS param_default_value, 1 AS append_filter, NULL  AS tooltip,0 AS column_template  FROM sys.objects o    INNER JOIN data_source ds ON ds.[name] = 'Recovery Rate View'     AND ISNULL(ds.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    LEFT JOIN report r ON r.report_id = ds.report_id     AND ds.[type_id] = 2     AND ISNULL(r.report_id , -1) = ISNULL(@report_id_data_source_dest, -1)    WHERE ds.type_id = (CASE WHEN r.report_id IS NULL THEN ds.type_id ELSE 2 END)   END       
   DELETE dsc   FROM data_source_column dsc    INNER JOIN data_source ds ON ds.data_source_id = dsc.source_id     AND ds.[name] = 'Recovery Rate View'    AND ISNULL(report_id, -1) =  ISNULL(@report_id_data_source_dest, -1)   LEFT JOIN #data_source_column tdsc ON tdsc.column_id = dsc.data_source_column_id   WHERE tdsc.column_id IS NULL   
COMMIT TRAN    END TRY   BEGIN CATCH    IF @@TRANCOUNT > 0     ROLLBACK TRAN;         DECLARE @error_msg VARCHAR(1000)                SET @error_msg = ERROR_MESSAGE()                RAISERROR (@error_msg, 16, 1);   END CATCH   